<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8" />
    <title>ê´€ê´‘ì§€ ëª©ë¡ - TATO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link th:href="@{/css/base.css}" rel="stylesheet">

    <!-- Papa Parse (CSV) -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        :root{
            --primary-color:#2563eb; --primary-hover:#1d4ed8;
            --background:#f8fafc; --text-primary:#1e293b; --text-secondary:#64748b;
            --border:#e2e8f0; --card-shadow:0 2px 4px rgba(0,0,0,0.1);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{min-height:100%;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--background);color:var(--text-primary)}

        /* Header */
        .header{height:64px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:1000;box-shadow:var(--card-shadow)}
        .logo{font-size:24px;font-weight:800;color:var(--primary-color);letter-spacing:-.5px;text-decoration:none}
        .header-nav{display:flex;gap:16px;align-items:center}
        .btn{padding:8px 16px;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:.2s;text-decoration:none;display:inline-block;text-align:center;font-size:14px}
        .btn-primary{background:var(--primary-color);color:#fff}.btn-primary:hover{background:var(--primary-hover)}
        .btn-secondary{background:#f1f5f9;color:var(--text-primary)} .btn-secondary:hover{background:#e2e8f0}

        /* Layout */
        .container{display:flex;min-height:calc(100vh - 64px)}

        /* Sidebar */
        .sidebar{width:300px;background:#fff;padding:24px;border-right:1px solid var(--border)}
        .listings-count{font-size:48px;font-weight:bold;color:var(--primary-color);margin-bottom:4px}
        .listings-text{color:var(--text-secondary);font-size:14px;margin-bottom:20px}
        .view-all-btn{background:var(--primary-color);color:#fff;padding:10px 20px;border-radius:20px;border:none;cursor:pointer;font-weight:500;margin-bottom:30px}
        .view-all-btn:hover{background:var(--primary-hover)}

        .filter-title{font-size:18px;font-weight:600;margin-bottom:20px;color:var(--text-primary)}

        /* Search */
        .search-box{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;margin-bottom:20px}
        .search-box:focus{outline:none;border-color:var(--primary-color)}

        /* Category Filters */
        .category-title{font-size:16px;font-weight:600;margin-bottom:12px;color:var(--text-primary)}
        .filter-option{display:flex;align-items:center;margin-bottom:8px;cursor:pointer;padding:2px 0}
        .filter-option input[type="checkbox"]{margin-right:8px;width:16px;height:16px}
        .filter-option label{cursor:pointer;font-size:14px;color:var(--text-primary)}

        /* Main Content */
        .main-content{flex:1;padding:24px}
        .content-header{margin-bottom:30px;text-align:center}
        .page-title{font-size:32px;font-weight:700;margin-bottom:8px}
        .page-subtitle{color:var(--text-secondary);font-size:16px}

        /* Grid */
        .attractions-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:40px}
        .attraction-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);transition:.2s;cursor:pointer}
        .attraction-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}

        /* âœ… ì´ë¯¸ì§€ í¬ê¸° í†µì¼ - í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ */
        .card-image{
            height:200px;
            width:100%;
            position:relative;
            overflow:hidden;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            display:flex;
            align-items:center;
            justify-content:center;
            color:#fff;
            font-size:48px;
        }

        /* ì´ë¯¸ì§€ê°€ ìˆì„ ë•Œ í†µì¼ëœ í¬ê¸°ë¡œ í‘œì‹œ */
        .card-image img{
            width:100%;
            height:100%;
            object-fit:cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ì˜ì—­ ì±„ìš°ê¸° */
            display:block;
        }

        .card-content{padding:16px}
        .card-title{font-size:16px;font-weight:600;margin-bottom:8px;line-height:1.3}
        .card-rating{display:flex;align-items:center;gap:6px;margin-bottom:8px}
        .stars{color:#fbbf24;font-size:14px}
        .rating-text{font-size:14px;color:var(--text-secondary)}
        .card-category{background:#eff6ff;color:var(--primary-color);padding:4px 8px;border-radius:12px;font-size:12px;display:inline-block}

        /* Pagination */
        .pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:32px}
        .page-btn{padding:8px 12px;border:1px solid var(--border);background:#fff;color:var(--text-primary);border-radius:6px;cursor:pointer;font-size:14px}
        .page-btn:hover{background:#f8fafc}
        .page-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
        .page-btn:disabled{opacity:0.5;cursor:not-allowed}

        /* Empty State */
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}

        /* Responsive */
        @media (max-width:1200px){
            .attractions-grid{grid-template-columns:repeat(2,1fr)}
        }
        @media (max-width:768px){
            .container{flex-direction:column}
            .sidebar{width:100%;padding:16px}
            .attractions-grid{grid-template-columns:1fr}
            .page-title{font-size:24px}
        }
    </style>
</head>
<body>
<header class="header">
    <a th:href="@{/}" class="logo">TATO</a>
    <nav class="header-nav">
        <a th:href="@{/}" class="btn btn-secondary">í™ˆ</a>


        <span sec:authorize="isAnonymous()">
            <a th:href="@{/login}" class="btn btn-primary">ë¡œê·¸ì¸</a>
            <a th:href="@{/register}" class="btn btn-secondary">íšŒì›ê°€ì…</a>
        </span>

        <span sec:authorize="isAuthenticated()">
            <a th:href="@{/favorites}" class="btn btn-secondary">ì¦ê²¨ì°¾ê¸°</a>
            <span th:text="${username} ?: ${#authentication.name}">ì‚¬ìš©ì</span>
            <form th:action="@{/logout}" method="post" style="display:inline;">
                <button type="submit" class="btn btn-primary">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </span>
    </nav>
</header>

<div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="listings-count" id="listingsCount">54</div>
        <div class="listings-text">ê°œì˜ ê´€ê´‘ì§€ê°€ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        <button class="view-all-btn" onclick="showAll()">ì „ì²´ ë³´ê¸° â†’</button>

        <h3 class="filter-title">í•„í„°</h3>

        <!-- Search -->
        <input id="searchInput" class="search-box" placeholder="ê´€ê´‘ì§€ ì´ë¦„ ê²€ìƒ‰..." onkeyup="applyFilters()">

        <!-- Categories -->
        <h4 class="category-title">ì¹´í…Œê³ ë¦¬</h4>
        <div id="categoryFilters">
            <!-- ë™ì  ìƒì„± -->
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-header">
            <h1 class="page-title">ë„ì¿„ ê´€ê´‘ì§€</h1>
            <p class="page-subtitle">ê²€ìƒ‰/í•„í„°ë¡œ ì›í•˜ëŠ” ì¥ì†Œë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ë³´ì„¸ìš”</p>
        </div>

        <section id="attractionsGrid" class="attractions-grid">
            <div class="empty-state">ê´€ê´‘ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </section>

        <div id="pagination" class="pagination" style="display:none;">
            <!-- ë™ì  ìƒì„± -->
        </div>
    </main>
</div>

<script>
    let allAttractions = [], filteredAttractions = [], currentPage = 1;
    const itemsPerPage = 9;
    let selectedCategories = new Set();

    // ìˆ˜ë™ ì´ë¯¸ì§€ ë°ì´í„°
    const manualData = {
        images: {
            '1': '/images/attractions/architecture_img01.jpg',
            '2': '/images/attractions/architecture_img02.jpg',
            '3': '/images/attractions/architecture_img03.jpg',
            '4': '/images/attractions/architecture_img04.jpg',
            '5': '/images/attractions/architecture_img05.jpg',
            '6': '/images/attractions/architecture_img06.jpg',
            '7': '/images/attractions/architecture_img07.jpg',
            '8': '/images/attractions/architecture_img08.jpg',
            '9': '/images/attractions/architecture_img09.jpg'
        },
    };

    // CSV ë°ì´í„° ë¡œë“œ
    Papa.parse('/data/tokyo_attractions.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (result) => {
            allAttractions = result.data
                .filter(r => r.name && r.latitude && r.longitude)
                .map(r => ({
                    id: r.spot_id || r.id,
                    name: r.name.trim(),
                    category: (r.category || 'ê¸°íƒ€').trim(),
                    address: (r.address || '').trim(),
                    latitude: parseFloat(r.latitude),
                    longitude: parseFloat(r.longitude)
                }))
                .filter(a => !isNaN(a.latitude) && !isNaN(a.longitude));

            initializePage();
        },
        error: (error) => {
            document.getElementById('attractionsGrid').innerHTML =
                '<div class="empty-state" style="color:#ef4444">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
            console.error('CSV ë¡œë”© ì—ëŸ¬:', error);
        }
    });

    function initializePage() {
        setupCategoryFilters();
        filteredAttractions = [...allAttractions];
        updateListingsCount();
        renderAttractions();
        renderPagination();
    }

    function setupCategoryFilters() {
        // ğŸ¯ ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ê°œë³„ì ìœ¼ë¡œ ë¶„í• í•˜ì—¬ ìˆ˜ì§‘
        const allCategories = new Set();

        allAttractions.forEach(attraction => {
            if (attraction.category) {
                // ì‰¼í‘œë¡œ ë¶„í• í•˜ì—¬ ê°œë³„ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
                const categories = attraction.category.split(',').map(c => c.trim());
                categories.forEach(category => {
                    if (category && category !== '') {
                        allCategories.add(category);
                    }
                });
            }
        });

        const categories = Array.from(allCategories).sort();
        const container = document.getElementById('categoryFilters');

        container.innerHTML = categories.map(category => `
        <div class="filter-option">
            <input type="checkbox" id="cat_${category}" value="${category}" onchange="toggleCategory('${category}')">
            <label for="cat_${category}">${category}</label>
        </div>
    `).join('');
    }

    function toggleCategory(category) {
        if (selectedCategories.has(category)) {
            selectedCategories.delete(category);
        } else {
            selectedCategories.add(category);
        }
        applyFilters();
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredAttractions = allAttractions.filter(attraction => {
            const matchesSearch = !searchTerm ||
                attraction.name.toLowerCase().includes(searchTerm) ||
                (attraction.category && attraction.category.toLowerCase().includes(searchTerm)) ||
                attraction.address.toLowerCase().includes(searchTerm);

            const matchesCategory = selectedCategories.size === 0 ||
                (attraction.category &&
                    attraction.category.split(',').map(c => c.trim()).some(cat => selectedCategories.has(cat)));

            return matchesSearch && matchesCategory;
        });

        currentPage = 1;
        updateListingsCount();
        renderAttractions();
        renderPagination();
    }

    function updateListingsCount() {
        document.getElementById('listingsCount').textContent = filteredAttractions.length;
        const countElement = document.getElementById('listingsCount');
        const textElement = document.querySelector('.listings-text');

    }

    function renderAttractions() {
        const container = document.getElementById('attractionsGrid');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageAttractions = filteredAttractions.slice(startIndex, endIndex);

        if (pageAttractions.length === 0) {
            container.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        container.innerHTML = pageAttractions.map(attraction => {
            const rating = 5.0;
            const imageUrl = manualData.images[attraction.id];
            const stars = 'â˜…â˜…â˜…â˜…â˜…';

            // ğŸ¯ ì¹´í…Œê³ ë¦¬ë¥¼ ì‰¼í‘œë¡œ ë¶„í• í•˜ì—¬ ê°œë³„ íƒœê·¸ ìƒì„±
            let categoryTags = '';
            if (attraction.category) {
                const categories = attraction.category.split(',').map(c => c.trim());
                categoryTags = categories.map((category, index) =>
                    `<span class="card-category${index === 0 ? ' primary' : ''}">${escapeHtml(category)}</span>`
                ).join('');
            } else {
                categoryTags = '<span class="card-category">ê¸°íƒ€</span>';
            }

            return `
            <div class="attraction-card" onclick="goToDetail('${attraction.id}')">
                <div class="card-image">
                    ${imageUrl ?
                `<img src="${imageUrl}" alt="${attraction.name}" loading="lazy">` :
                `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:48px;">ğŸ“</div>`
            }
                </div>
                <div class="card-content">
                    <h3 class="card-title">${escapeHtml(attraction.name)}</h3>
                    <div class="card-rating">
                        <span class="stars">${stars}</span>
                        <span class="rating-text">${rating.toFixed(1)}</span>
                    </div>
                    <div class="categories-container">
                        ${categoryTags}
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredAttractions.length / itemsPerPage);
        const container = document.getElementById('pagination');

        if (totalPages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';

        let html = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">â€¹</button>`;

        for (let i = 1; i <= totalPages; i++) {
            html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
        }

        html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">â€º</button>`;

        container.innerHTML = html;
    }

    function changePage(page) {
        const totalPages = Math.ceil(filteredAttractions.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderAttractions();
            renderPagination();
            document.querySelector('.main-content').scrollTop = 0;
        }
    }

    function goToDetail(id) {
        window.location.href = `/attractions/${encodeURIComponent(id)}`;
    }

    function showAll() {
        selectedCategories.clear();
        document.getElementById('searchInput').value = '';
        document.querySelectorAll('#categoryFilters input').forEach(cb => cb.checked = false);
        applyFilters();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>