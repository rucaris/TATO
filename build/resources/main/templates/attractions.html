<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8" />
    <title>ê´€ê´‘ì§€ ëª©ë¡ - TATO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/css/base.css}" rel="stylesheet">

    <style>
        :root{
            --primary-color:#2563eb; --primary-hover:#1d4ed8;
            --background:#f8fafc; --text-primary:#1e293b; --text-secondary:#64748b;
            --border:#e2e8f0; --card-shadow:0 2px 4px rgba(0,0,0,0.1);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{min-height:100%;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--background);color:var(--text-primary)}

        /* Header */
        .header{height:64px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:1000;box-shadow:var(--card-shadow)}
        .logo{font-size:24px;font-weight:800;color:var(--primary-color);letter-spacing:-.5px;text-decoration:none}
        .header-nav{display:flex;gap:16px;align-items:center}
        .btn{padding:8px 16px;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:.2s;text-decoration:none;display:inline-block;text-align:center;font-size:14px;background:#f1f5f9;color:var(--text-primary)}
        .btn:hover{background:#e2e8f0}
        .btn-primary{background:var(--primary-color);color:#fff}.btn-primary:hover{background:var(--primary-hover)}
        .btn-secondary{background:#f1f5f9;color:var(--text-primary)} .btn-secondary:hover{background:#e2e8f0}

        /* Layout */
        .container{display:flex;min-height:calc(100vh - 64px)}

        /* Sidebar */
        .sidebar{width:300px;background:#fff;padding:24px;border-right:1px solid var(--border)}
        .listings-count{font-size:48px;font-weight:bold;color:var(--primary-color);margin-bottom:4px}
        .listings-text{color:var(--text-secondary);font-size:14px;margin-bottom:16px}
        .view-all-btn{background:var(--primary-color);color:#fff;padding:12px 16px;border:none;border-radius:8px;font-weight:500;cursor:pointer;width:100%;margin-bottom:32px}

        /* Filters */
        .filter-title,.category-title{font-size:16px;font-weight:600;margin:24px 0 12px 0}
        .search-box{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:16px}
        .category-filter{display:flex;flex-direction:column;gap:8px}
        .category-item{display:flex;align-items:center;gap:8px}
        .category-item input{margin:0}
        .category-item label{cursor:pointer;font-size:14px}

        /* Main Content */
        .main-content{flex:1;padding:24px}
        .content-header{margin-bottom:32px}
        .page-title{font-size:32px;font-weight:700;margin-bottom:8px}
        .page-subtitle{color:var(--text-secondary);font-size:16px}

        /* Attractions Grid */
        .attractions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:24px;margin-bottom:32px}
        .attraction-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);transition:.2s;cursor:pointer}
        .attraction-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .card-image{width:100%;height:200px;background:#f8f9fa;position:relative}
        .card-image img{width:100%;height:100%;object-fit:cover}
        .card-content{padding:16px}
        .card-title{font-size:18px;font-weight:600;margin-bottom:8px;line-height:1.3}
        .card-meta{color:var(--text-secondary);font-size:14px;margin-bottom:8px}
        .card-categories{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0}
        .card-category{background:#eff6ff;color:#2563eb;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:500}
        .card-category.primary{background:#2563eb;color:#fff}
        .card-rating{color:#fbbf24;font-size:14px;margin-bottom:12px}

        /* ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .card-actions{display:flex;gap:8px;justify-content:space-between;align-items:center}
        .btn-detail {padding: 6px 12px;border: 1px solid #333;background: transparent;color: #333;border-radius: 4px;font-size: 13px;}        .btn-favorite{background:#ef4444;color:#fff;border:none;padding:8px 12px;border-radius:6px;font-size:12px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:4px}
        .btn-favorite:hover{background:#dc2626;transform:translateY(-1px)}
        .btn-favorite.favorited{background:#10b981}
        .btn-favorite.favorited:hover{background:#059669}

        /* Pagination */
        .pagination{display:flex;justify-content:center;gap:8px;margin-top:32px}
        .pagination button{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:6px;cursor:pointer}
        .pagination button.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
        .pagination button:hover:not(.active){background:#f8f9fa}

        .empty-state{text-align:center;padding:48px;color:var(--text-secondary);font-size:16px}
    </style>
</head>
<body>

<!-- Header -->
<header class="header">
    <a th:href="@{/}" class="logo">TATO</a>
    <nav class="header-nav">
        <a th:href="@{/}" class="btn">í™ˆ</a>
        <a th:href="@{/attractions}" class="btn btn-primary">ëª©ë¡</a>

        <span sec:authorize="isAnonymous()">
            <a th:href="@{/login}" class="btn btn-primary">ë¡œê·¸ì¸</a>
            <a th:href="@{/register}" class="btn">íšŒì›ê°€ì…</a>
        </span>

        <span sec:authorize="isAuthenticated()">
            <a th:href="@{/favorites}" class="btn">ì¦ê²¨ì°¾ê¸°</a>
            <span th:text="${username}" sec:authentication="name">ì‚¬ìš©ì</span>
            <form th:action="@{/logout}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-primary">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
        </span>
    </nav>
</header>

<div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="listings-count" id="listingsCount">0</div>
        <div class="listings-text">ê°œì˜ ê´€ê´‘ì§€ê°€ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        <button class="view-all-btn" onclick="showAll()">ì „ì²´ ë³´ê¸° â†’</button>

        <h3 class="filter-title">í•„í„°</h3>

        <!-- Search -->
        <input id="searchInput" class="search-box" placeholder="ê´€ê´‘ì§€ ì´ë¦„ ê²€ìƒ‰..." onkeyup="applyFilters()">

        <!-- Categories -->
        <h4 class="category-title">ì¹´í…Œê³ ë¦¬</h4>
        <div id="categoryFilters" class="category-filter">
            <!-- ë™ì  ìƒì„± -->
        </div>

        <!-- ê´€ê´‘ì§€ ì‹ ì²­ ë²„íŠ¼ ì¶”ê°€ -->
        <div sec:authorize="isAuthenticated()" style="margin-top: 24px;">
            <a href="/favorites#submit" class="btn btn-secondary" style="width: 100%; text-align: center; display: block;">
                ê´€ê´‘ì§€ ì‹ ì²­í•˜ê¸°
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-header">
            <h1 class="page-title">ë„ì¿„ ê´€ê´‘ì§€</h1>
            <p class="page-subtitle">ê²€ìƒ‰/í•„í„°ë¡œ ì›í•˜ëŠ” ì¥ì†Œë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ë³´ì„¸ìš”</p>
        </div>

        <section id="attractionsGrid" class="attractions-grid">
            <div class="empty-state">ê´€ê´‘ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </section>

        <div id="pagination" class="pagination" style="display:none;">
            <!-- ë™ì  ìƒì„± -->
        </div>
    </main>
</div>

<script>
    let allAttractions = [], filteredAttractions = [], currentPage = 1;
    const itemsPerPage = 9;
    let selectedCategories = new Set();

    // ìˆ˜ë™ ì´ë¯¸ì§€ ë°ì´í„°
    const manualData = {
        images: {
            '1': '/images/attractions/architecture_img01.jpg',
            '2': '/images/attractions/architecture_img02.jpg',
            '3': '/images/attractions/architecture_img03.jpg',
            '4': '/images/attractions/architecture_img04.jpg',
            '5': '/images/attractions/architecture_img05.jpg',
            '6': '/images/attractions/architecture_img06.jpg',
            '7': '/images/attractions/architecture_img07.jpg',
            '8': '/images/attractions/architecture_img08.jpg',
            '9': '/images/attractions/architecture_img09.jpg'
        },
    };

    // ë°ì´í„° ë¡œë”©
    fetch('/api/attractions')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ë¡œë“œëœ ì›ë³¸ ë°ì´í„°:', data);
            console.log('ë°ì´í„° ê°œìˆ˜:', data.length);

            // ê° ê´€ê´‘ì§€ì˜ ì¹´í…Œê³ ë¦¬ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            data.forEach((attraction, index) => {
                if (index < 5) { // ì²˜ìŒ 5ê°œë§Œ ì¶œë ¥
                    console.log(`ê´€ê´‘ì§€ ${index + 1}: ${attraction.name} - ì¹´í…Œê³ ë¦¬: ${attraction.category}`);
                }
            });

            allAttractions = data;
            filteredAttractions = data;
            setupCategories();
            updateListingsCount();
            renderAttractions();
            renderPagination();

            console.log('ë°ì´í„° ë¡œë”© ì™„ë£Œ. ê²€ìƒ‰ ê°€ëŠ¥ ìƒíƒœ.');
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
            document.getElementById('attractionsGrid').innerHTML =
                '<div class="empty-state">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        });

    function setupCategories() {
        // ğŸ”§ ì¹´í…Œê³ ë¦¬ ì„¤ì • ìˆ˜ì • - ì•ˆì „í•œ íŒŒì‹±
        const allCategories = new Set();

        allAttractions.forEach(attraction => {
            if (attraction.category) {
                // ì‰¼í‘œ êµ¬ë¶„
                const categories = attraction.category.split(',').map(c => c.trim()).filter(c => c);
                categories.forEach(category => allCategories.add(category));
            }
        });

        const categoriesArray = Array.from(allCategories).sort();
        const container = document.getElementById('categoryFilters');

        container.innerHTML = categoriesArray.map(category => `
            <div class="category-item">
                <input type="checkbox" id="category_${category}" onchange="toggleCategory('${category}')">
                <label for="category_${category}">${escapeHtml(category)}</label>
            </div>
        `).join('');
    }

    function toggleCategory(category) {
        if (selectedCategories.has(category)) {
            selectedCategories.delete(category);
        } else {
            selectedCategories.add(category);
        }
        applyFilters();
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredAttractions = allAttractions.filter(attraction => {
            const matchesSearch = !searchTerm ||
                attraction.name.toLowerCase().includes(searchTerm) ||
                (attraction.category && attraction.category.toLowerCase().includes(searchTerm)) ||
                attraction.address.toLowerCase().includes(searchTerm);

            const matchesCategory = selectedCategories.size === 0 ||
                (attraction.category &&
                    attraction.category.split(',').map(c => c.trim()).some(cat => selectedCategories.has(cat)));

            return matchesSearch && matchesCategory;
        });

        currentPage = 1;
        updateListingsCount();
        renderAttractions();
        renderPagination();
    }

    function updateListingsCount() {
        document.getElementById('listingsCount').textContent = filteredAttractions.length;
    }

    function renderAttractions() {
        const container = document.getElementById('attractionsGrid');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageAttractions = filteredAttractions.slice(startIndex, endIndex);

        if (pageAttractions.length === 0) {
            container.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        container.innerHTML = pageAttractions.map(attraction => {
            const rating = 5.0;
            const imageUrl = manualData.images[attraction.id];
            const stars = 'â˜…â˜…â˜…â˜…â˜…';

            // ì¹´í…Œê³ ë¦¬ë¥¼ ì‰¼í‘œë¡œ ë¶„í• í•˜ì—¬ ê°œë³„ íƒœê·¸ ìƒì„±
            let categoryTags = '';
            if (attraction.category) {
                try {
                    const categories = attraction.category.split(',').map(c => c.trim()).filter(c => c);
                    categoryTags = categories.map((category, index) =>
                        `<span class="card-category${index === 0 ? ' primary' : ''}">${escapeHtml(category)}</span>`
                    ).join('');
                } catch (error) {
                    console.error('ì¹´í…Œê³ ë¦¬ íŒŒì‹± ì˜¤ë¥˜:', error);
                    categoryTags = '<span class="card-category">ê¸°íƒ€</span>';
                }
            } else {
                categoryTags = '<span class="card-category">ê¸°íƒ€</span>';
            }

            return `
            <div class="attraction-card">
                <div class="card-image" onclick="goToDetail('${attraction.id}')">
                    ${imageUrl ?
                `<img src="${imageUrl}" alt="${escapeHtml(attraction.name)}" />` :
                '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">ğŸ“</div>'
            }
                </div>
                <div class="card-content">
                    <div class="card-title" onclick="goToDetail('${attraction.id}')">${escapeHtml(attraction.name)}</div>
                    <div class="card-meta">${escapeHtml(attraction.address || '')}</div>
                    <div class="card-categories">${categoryTags}</div>
                    <div class="card-rating">${stars} ${rating}</div>

                    <!--  ë²„íŠ¼ ì˜ì—­ ì¶”ê°€ -->
                    <div class="card-actions">
                        <button class="btn-favorite" onclick="toggleFavorite(${attraction.id}, this)" data-attraction-id="${attraction.id}">
                            ì¦ê²¨ì°¾ê¸°
                        </button>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    function renderPagination() {
        const container = document.getElementById('pagination');
        const totalPages = Math.ceil(filteredAttractions.length / itemsPerPage);

        if (totalPages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';
        let paginationHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `
                <button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                    ${i}
                </button>
            `;
        }

        container.innerHTML = paginationHTML;
    }

    function goToPage(page) {
        currentPage = page;
        renderAttractions();
        renderPagination();
        window.scrollTo(0, 0);
    }

    function goToDetail(id) {
        window.location.href = `/attractions/${id}`;
    }

    function showAll() {
        selectedCategories.clear();
        document.getElementById('searchInput').value = '';
        document.querySelectorAll('#categoryFilters input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        applyFilters();
    }

    //  CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCsrfToken() {
        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
        return {
            token: csrfToken ? csrfToken.getAttribute('content') : null,
            header: csrfHeader ? csrfHeader.getAttribute('content') : null
        };
    }

    //  ì¦ê²¨ì°¾ê¸° í† ê¸€ í•¨ìˆ˜
    async function toggleFavorite(attractionId, button) {
        console.log('ì¦ê²¨ì°¾ê¸° í† ê¸€ ì‹œë„:', attractionId);

        // ê°•í™”ëœ ë¡œê·¸ì¸ ì²´í¬ - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ í™•ì¸
        const authSpan = document.querySelector('span[sec\\:authorize="isAuthenticated()"]');
        const userSpan = document.querySelector('span[sec\\:authentication="name"]');
        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const logoutForm = document.querySelector('form[action*="/logout"]');

        const isLoggedIn = authSpan || userSpan || (csrfToken && logoutForm);

        console.log('ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬:', {
            authSpan: !!authSpan,
            userSpan: !!userSpan,
            csrfToken: !!csrfToken,
            logoutForm: !!logoutForm,
            isLoggedIn: !!isLoggedIn
        });

        if (!isLoggedIn) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        try {
            const csrf = getCsrfToken();
            const headers = {
                'Content-Type': 'application/json',
            };

            if (csrf.token && csrf.header) {
                headers[csrf.header] = csrf.token;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = 'ì²˜ë¦¬ì¤‘...';

            const response = await fetch(`/favorites/${attractionId}`, {
                method: 'POST',
                headers: headers
            });

            console.log('ì¦ê²¨ì°¾ê¸° ì‘ë‹µ ìƒíƒœ:', response.status);

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('ì¦ê²¨ì°¾ê¸° ì‘ë‹µ:', result);

            if (result.success) {
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                if (result.favorited) {
                    button.classList.add('favorited');
                    button.textContent = 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€';
                } else {
                    button.classList.remove('favorited');
                    button.textContent = 'ì¦ê²¨ì°¾ê¸° ì œê±°';
                }

                // ì„±ê³µ ë©”ì‹œì§€
                showToast(result.message);
            } else {
                throw new Error(result.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

        } catch (error) {
            console.error('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);

            // ì—ëŸ¬ì‹œ ë²„íŠ¼ ë³µêµ¬
            button.textContent = originalText;
        } finally {
            button.disabled = false;
        }
    }

    //  í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

</body>
</html>