<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="utf-8" />
  <title>ì¦ê²¨ì°¾ê¸° - TATO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <link th:href="@{/css/base.css}" rel="stylesheet">

  <style>
    :root { --primary-color:#2563eb; --primary-hover:#1d4ed8; --background:#f8fafc;
      --text-primary:#1e293b; --text-secondary:#64748b; --border:#e2e8f0; --card-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1); }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{min-height:100%;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--background);color:var(--text-primary)}
    .header{height:64px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:1000;box-shadow:var(--card-shadow)}
    .logo{font-size:24px;font-weight:800;color:var(--primary-color);letter-spacing:-.5px;text-decoration:none}
    .header-nav{display:flex;gap:12px;align-items:center}
    .btn{padding:8px 14px;border:0;border-radius:8px;font-weight:500;cursor:pointer;transition:.2s;text-decoration:none;display:inline-block}
    .btn-primary{background:var(--primary-color);color:#fff}.btn-primary:hover{background:var(--primary-hover)}
    .btn-secondary{background:#f1f5f9;color:var(--text-primary)} .btn-secondary:hover{background:#e2e8f0}
    .btn-danger{background:#ef4444;color:#fff} .btn-danger:hover{background:#dc2626}
    .btn-success{background:#10b981;color:#fff} .btn-success:hover{background:#059669}
    .main{max-width:1200px;margin:0 auto;padding:24px}
    .breadcrumb{margin-bottom:16px;color:var(--text-secondary);font-size:14px}
    .breadcrumb a{color:inherit;text-decoration:none}.breadcrumb a:hover{color:var(--primary-color)}
    .page-title{font-size:28px;font-weight:700;margin:6px 0 20px}
    .stats{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--card-shadow)}
    .stats h3{font-size:16px;font-weight:600;margin-bottom:4px}.stats strong{font-size:24px;color:var(--primary-color)}
    .panel{background:#fff;border-radius:16px;padding:20px;box-shadow:var(--card-shadow);margin-bottom:20px}
    .panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff;transition:.2s;cursor:pointer;position:relative}
    .card:hover{border-color:var(--primary-color);transform:translateY(-2px);box-shadow:0 8px 24px -8px rgb(0 0 0 / .12)}
    .thumb{height:160px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-size:44px}
    .card-body{padding:14px}.title{font-weight:700;margin-bottom:6px}.meta{font-size:13px;color:var(--text-secondary);margin-bottom:10px}
    .badge{background:#eff6ff;color:var(--primary-color);padding:2px 8px;border-radius:10px;font-size:12px}
    .row{display:flex;align-items:center;gap:8px;justify-content:space-between}

    /* ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ */
    .categories-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 10px;
    }
    .category-tag {
      background: #eff6ff;
      color: #2563eb;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      border: 1px solid #e0f2fe;
      font-weight: 500;
      display: inline-block;
    }
    .category-tag.primary {
      background: #2563eb !important;
      color: #fff !important;
      border-color: #2563eb !important;
      font-weight: 600 !important;
    }

    /* ì¦ê²¨ì°¾ê¸° í•´ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .favorite-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .btn-unfavorite {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-unfavorite:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* ê´€ê´‘ì§€ ì‹ ì²­ í¼ ìŠ¤íƒ€ì¼ */
    .submit-form {
      margin-top: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
    }

    .alert {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
      padding: 12px 14px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .tab-button {
      padding: 12px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab-button.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    @media (max-width:768px){
      .page-title{font-size:24px}
      .stats{flex-direction:column;gap:10px}
      .form-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header class="header">
  <a th:href="@{/}" class="logo">TATO</a>
  <nav class="header-nav">
    <a th:href="@{/}" class="btn btn-secondary">í™ˆ</a>
    <a th:href="@{/attractions}" class="btn btn-secondary">ëª©ë¡</a>
    <span sec:authorize="isAnonymous()">
      <a th:href="@{/login}" class="btn btn-primary">ë¡œê·¸ì¸</a>
      <a th:href="@{/register}" class="btn btn-secondary">íšŒì›ê°€ì…</a>
    </span>
    <span sec:authorize="isAuthenticated()">
      <span th:text="${username} ?: ${#authentication.name}">ì‚¬ìš©ì</span>
      <form th:action="@{/logout}" method="post" style="display:inline"><button class="btn btn-primary">ë¡œê·¸ì•„ì›ƒ</button></form>
    </span>
  </nav>
</header>

<main class="main">
  <nav class="breadcrumb"><a th:href="@{/}">í™ˆ</a> &gt; <strong>ë§ˆì´í˜ì´ì§€</strong></nav>
  <h1 class="page-title">ë§ˆì´í˜ì´ì§€</h1>

  <section class="stats">
    <div><h3>ì´ ì¦ê²¨ì°¾ê¸°</h3><strong th:text="${favoritesCount}">0</strong></div>
    <div><a th:href="@{/attractions}" class="btn btn-primary">ê´€ê´‘ì§€ ë” ë³´ëŸ¬ê°€ê¸°</a></div>
  </section>

  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('favorites')">ë‚´ ì¦ê²¨ì°¾ê¸°</button>
    <button class="tab-button" onclick="switchTab('submit')">ê´€ê´‘ì§€ ì‹ ì²­</button>
  </div>

  <!-- ì¦ê²¨ì°¾ê¸° íƒ­ -->
  <div id="favorites-tab" class="tab-content active">
    <section class="panel">
      <div class="panel-head">
        <h2 style="font-size:18px;font-weight:700;">ì°œí•œ ê´€ê´‘ì§€</h2>
        <div style="color:var(--text-secondary);font-size:13px" th:if="${#lists.isEmpty(favorites)}">ì•„ì§ ì°œì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>

      <div class="grid" th:if="${!#lists.isEmpty(favorites)}">
        <!-- ì¹´ë“œ ë°˜ë³µ -->
        <article class="card" th:each="fav : ${favorites}" th:data-attraction-id="${fav.attractionId}">
          <!-- ìƒì„¸ë³´ê¸°ëŠ” ì¹´ë“œ í´ë¦­ìœ¼ë¡œ -->
          <div class="card-clickable" th:onclick="|location.href='@{/attractions/{id}(id=${fav.attractionId})}'|">
            <div class="thumb">
              <img th:if="${fav.imageUrl}"
                   th:src="${fav.imageUrl}"
                   th:alt="${fav.name} + ' ì´ë¯¸ì§€'"
                   style="width:100%; height:100%; object-fit:cover; border-radius:8px;">
              <div th:unless="${fav.imageUrl}"
                   style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
                ğŸ“
              </div>
            </div>
            <div class="card-body">
              <div class="title" th:text="${fav.name}">ê´€ê´‘ì§€ëª…</div>
              <div class="meta" th:text="${fav.address}">ì£¼ì†Œ</div>

              <div class="categories-container">
                <!-- Thymeleafë¡œ ì‰¼í‘œë¡œ ë¶„í• í•˜ì—¬ ë°˜ë³µ -->
                <th:block th:each="category, iterStat : ${#strings.listSplit(fav.category, ',')}">
                  <span th:class="'category-tag' + (${iterStat.first} ? ' primary' : '')"
                        th:text="${#strings.trim(category)}">
                    ì¹´í…Œê³ ë¦¬
                  </span>
                </th:block>
              </div>
            </div>
          </div>

          <!-- ì¦ê²¨ì°¾ê¸° í•´ì œ ë²„íŠ¼ - ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ì™€ ë¶„ë¦¬ -->
          <div class="favorite-actions" style="padding: 0 14px 14px;">
            <span style="font-size: 12px; color: var(--text-secondary);">
              ì¦ê²¨ì°¾ê¸°
            </span>
            <button type="button"
                    class="btn-unfavorite"
                    th:data-attraction-id="${fav.attractionId}"
                    onclick="removeFavorite(this, event)">
              í•´ì œ
            </button>
          </div>
        </article>
      </div>
    </section>
  </div>

  <!-- ê´€ê´‘ì§€ ì‹ ì²­ íƒ­ -->
  <div id="submit-tab" class="tab-content">
    <section class="panel">
      <div class="panel-head">
        <h2 style="font-size:18px;font-weight:700;">ê´€ê´‘ì§€ ì‹ ì²­</h2>
        <div style="color:var(--text-secondary);font-size:13px">ìƒˆë¡œìš´ ë„ì¿„ ê´€ê´‘ì§€ë¥¼ ì¶”ì²œí•´ ì£¼ì„¸ìš”</div>
      </div>

      <!-- ì„±ê³µ/ì—ëŸ¬ ë©”ì‹œì§€ -->
      <div th:if="${submitSuccess}" class="alert">
        <span th:text="${submitSuccess}">ì„±ê³µ ë©”ì‹œì§€</span>
      </div>

      <div th:if="${submitError}" class="alert error">
        <span th:text="${submitError}">ì—ëŸ¬ ë©”ì‹œì§€</span>
      </div>

      <form class="submit-form" th:action="@{/attractions/submit}" method="post" novalidate>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="form-grid">
          <div class="form-group">
            <label for="name">ê´€ê´‘ì§€ëª… *</label>
            <input id="name" name="name" type="text" placeholder="ì˜ˆ: ì„¼ì†Œì§€" required/>
          </div>

          <div class="form-group">
            <label for="category">ì¹´í…Œê³ ë¦¬ *</label>
            <select id="category" name="category" required>
              <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
              <option value="ì‹ ì‚¬Â·ì‚¬ì°°">ì‹ ì‚¬Â·ì‚¬ì°°</option>
              <option value="ë¯¸ìˆ ê´€Â·ë°•ë¬¼ê´€">ë¯¸ìˆ ê´€Â·ë°•ë¬¼ê´€</option>
              <option value="ê³µì›Â·ë¬¸í™”ì‹œì„¤">ê³µì›Â·ë¬¸í™”ì‹œì„¤</option>
              <option value="ì‡¼í•‘">ì‡¼í•‘</option>
              <option value="ìŒì‹ì ">ìŒì‹ì </option>
              <option value="ì—”í„°í…Œì¸ë¨¼íŠ¸">ì—”í„°í…Œì¸ë¨¼íŠ¸</option>
              <option value="ìì—°Â·ì‚°Â·ê³µì›">ìì—°Â·ì‚°Â·ê³µì›</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>

          <div class="form-group full">
            <label for="address">ì£¼ì†Œ</label>
            <input id="address" name="address" type="text" placeholder="ì˜ˆ: ë„ì¿„ë„ ë‹¤ì´í† êµ¬ ì•„ì‚¬ì¿ ì‚¬ 2-3-1"/>
          </div>

          <div class="form-group">
            <label for="latitude">ìœ„ë„</label>
            <input id="latitude" name="latitude" type="text" placeholder="ì˜ˆ: 35.714765" pattern="[0-9.-]+"/>
          </div>

          <div class="form-group">
            <label for="longitude">ê²½ë„</label>
            <input id="longitude" name="longitude" type="text" placeholder="ì˜ˆ: 139.796727" pattern="[0-9.-]+"/>
          </div>

        </div>

        <div class="form-group">
          <label for="description">ì„¤ëª… *</label>
          <textarea id="description" name="description" placeholder="ê´€ê´‘ì§€ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..." required></textarea>
        </div>

        <button class="btn btn-success" type="submit" style="width: 100%; padding: 12px; font-size: 16px;">
          ì‹ ì²­í•˜ê¸°
        </button>
      </form>

      <div style="margin-top: 16px; text-align: center; color: var(--text-secondary); font-size: 14px;">
        ì‹ ì²­í•˜ì‹  ê´€ê´‘ì§€ëŠ” ê´€ë¦¬ì ê²€í†  í›„ ë“±ë¡ë©ë‹ˆë‹¤.
      </div>
    </section>
  </div>
</main>

<script>
  // íƒ­ ì „í™˜ í•¨ìˆ˜
  function switchTab(tabName) {
    // ëª¨ë“  íƒ­ ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });

    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
  }

  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  function getCsrfToken() {
    const csrfToken = document.querySelector('meta[name="_csrf"]');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
    return {
      token: csrfToken ? csrfToken.getAttribute('content') : null,
      header: csrfHeader ? csrfHeader.getAttribute('content') : null
    };
  }

  // ì¦ê²¨ì°¾ê¸° í•´ì œ í•¨ìˆ˜
  async function removeFavorite(button, event) {
    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ (ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€)
    event.preventDefault();
    event.stopPropagation();

    const attractionId = button.getAttribute('data-attraction-id');

    if (!confirm('ì •ë§ë¡œ ì¦ê²¨ì°¾ê¸°ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      const csrf = getCsrfToken();
      const headers = {
        'Content-Type': 'application/json',
      };

      if (csrf.token && csrf.header) {
        headers[csrf.header] = csrf.token;
      }

      // ë²„íŠ¼ ë¹„í™œì„±í™”
      button.disabled = true;
      button.textContent = 'ì²˜ë¦¬ì¤‘...';

      const response = await fetch(`/favorites/${encodeURIComponent(attractionId)}`, {
        method: 'POST',
        headers: headers
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        // ì„±ê³µì‹œ ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ì œê±°
        const card = button.closest('.card');
        card.style.transform = 'translateY(-10px)';
        card.style.opacity = '0';

        setTimeout(() => {
          card.remove();

          // ì¦ê²¨ì°¾ê¸° ê°œìˆ˜ ì—…ë°ì´íŠ¸
          updateFavoriteCount();

          // ëª¨ë“  ì¹´ë“œê°€ ì œê±°ë˜ì—ˆëŠ”ì§€ í™•ì¸
          checkEmptyState();
        }, 300);

        // ì„±ê³µ ë©”ì‹œì§€
        showToast('ì¦ê²¨ì°¾ê¸°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        throw new Error(result.message || 'ì¦ê²¨ì°¾ê¸° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

    } catch (error) {
      console.error('ì¦ê²¨ì°¾ê¸° í•´ì œ ì¤‘ ì˜¤ë¥˜:', error);
      alert('ì¦ê²¨ì°¾ê¸° í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);

      // ì—ëŸ¬ì‹œ ë²„íŠ¼ ë³µêµ¬
      button.disabled = false;
      button.textContent = 'í•´ì œ';
    }
  }

  // ì¦ê²¨ì°¾ê¸° ê°œìˆ˜ ì—…ë°ì´íŠ¸
  function updateFavoriteCount() {
    const remainingCards = document.querySelectorAll('.grid .card').length;
    const countElement = document.querySelector('.stats strong');
    if (countElement) {
      countElement.textContent = remainingCards;
    }
  }

  // ë¹ˆ ìƒíƒœ í™•ì¸
  function checkEmptyState() {
    const grid = document.querySelector('.grid');
    const remainingCards = document.querySelectorAll('.grid .card').length;

    if (remainingCards === 0) {
      grid.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">ì¦ê²¨ì°¾ê¸°í•œ ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br><a href="/attractions" style="color:var(--primary-color);">ê´€ê´‘ì§€ ë‘˜ëŸ¬ë³´ê¸°</a></div>';
    }
  }

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì‚¬í•­)
  function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 9999;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    `;
    toast.textContent = message;

    document.body.appendChild(toast);

    // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‚˜íƒ€ë‚´ê¸°
    setTimeout(() => {
      toast.style.transform = 'translateX(0)';
    }, 100);

    // 3ì´ˆ í›„ ì œê±°
    setTimeout(() => {
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }

  // í¼ ê²€ì¦
  document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash === '#submit') {
      switchTab('submit');
    } else {
      switchTab('favorites');
    }
  });

  // íƒ­ ì „í™˜ í•¨ìˆ˜ ìˆ˜ì •
  function switchTab(tabName) {
    // ëª¨ë“  íƒ­ ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });

    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    const targetButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
    if (targetButton) {
      targetButton.classList.add('active');
    }

    const targetContent = document.getElementById(tabName + '-tab');
    if (targetContent) {
      targetContent.classList.add('active');
    }

    // URL í•´ì‹œ ì—…ë°ì´íŠ¸
    window.location.hash = tabName;
  }

  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  function getCsrfToken() {
    const csrfToken = document.querySelector('meta[name="_csrf"]');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
    return {
      token: csrfToken ? csrfToken.getAttribute('content') : null,
      header: csrfHeader ? csrfHeader.getAttribute('content') : null
    };
  }

  // ì¦ê²¨ì°¾ê¸° í•´ì œ í•¨ìˆ˜
  async function removeFavorite(button, event) {
    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€ (ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ì™€ ì¶©ëŒ ë°©ì§€)
    event.preventDefault();
    event.stopPropagation();

    const attractionId = button.getAttribute('data-attraction-id');

    if (!confirm('ì •ë§ë¡œ ì¦ê²¨ì°¾ê¸°ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      const csrf = getCsrfToken();
      const headers = {
        'Content-Type': 'application/json',
      };

      if (csrf.token && csrf.header) {
        headers[csrf.header] = csrf.token;
      }

      // ë²„íŠ¼ ë¹„í™œì„±í™”
      button.disabled = true;
      button.textContent = 'ì²˜ë¦¬ì¤‘...';

      const response = await fetch(`/favorites/${encodeURIComponent(attractionId)}`, {
        method: 'POST',
        headers: headers
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        // ì„±ê³µì‹œ ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ ì œê±°
        const card = button.closest('.card');
        card.style.transform = 'translateY(-10px)';
        card.style.opacity = '0';

        setTimeout(() => {
          card.remove();

          // ì¦ê²¨ì°¾ê¸° ê°œìˆ˜ ì—…ë°ì´íŠ¸
          updateFavoriteCount();

          // ëª¨ë“  ì¹´ë“œê°€ ì œê±°ë˜ì—ˆëŠ”ì§€ í™•ì¸
          checkEmptyState();
        }, 300);

        // ì„±ê³µ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)
        showToast('ì¦ê²¨ì°¾ê¸°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        throw new Error(result.message || 'ì¦ê²¨ì°¾ê¸° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

    } catch (error) {
      console.error('ì¦ê²¨ì°¾ê¸° í•´ì œ ì¤‘ ì˜¤ë¥˜:', error);
      alert('ì¦ê²¨ì°¾ê¸° í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);

      // ì—ëŸ¬ì‹œ ë²„íŠ¼ ë³µêµ¬
      button.disabled = false;
      button.textContent = 'í•´ì œ';
    }
  }

  // ì¦ê²¨ì°¾ê¸° ê°œìˆ˜ ì—…ë°ì´íŠ¸
  function updateFavoriteCount() {
    const remainingCards = document.querySelectorAll('.grid .card').length;
    const countElement = document.querySelector('.stats strong');
    if (countElement) {
      countElement.textContent = remainingCards;
    }
  }

  // ë¹ˆ ìƒíƒœ í™•ì¸
  function checkEmptyState() {
    const grid = document.querySelector('.grid');
    const remainingCards = document.querySelectorAll('.grid .card').length;

    if (remainingCards === 0) {
      grid.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">ì¦ê²¨ì°¾ê¸°í•œ ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br><a href="/attractions" style="color:var(--primary-color);">ê´€ê´‘ì§€ ë‘˜ëŸ¬ë³´ê¸°</a></div>';
    }
  }

  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì‚¬í•­)
  function showToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // ê´€ê´‘ì§€ ì‹ ì²­ í¼ ì œì¶œ ì‹œ í™•ì¸
  document.addEventListener('DOMContentLoaded', function() {
    const submitForm = document.querySelector('.submit-form');
    if (submitForm) {
      submitForm.addEventListener('submit', function(e) {
        if (!confirm('ê´€ê´‘ì§€ ì‹ ì²­ì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          e.preventDefault();
        }
      });
    }
  });
</script>
</body>
</html>