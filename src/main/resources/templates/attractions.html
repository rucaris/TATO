<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8" />
    <title>관광지 목록 - TATO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/css/base.css}" rel="stylesheet">

    <style>
        :root{
            --primary-color:#2563eb; --primary-hover:#1d4ed8;
            --background:#f8fafc; --text-primary:#1e293b; --text-secondary:#64748b;
            --border:#e2e8f0; --card-shadow:0 2px 4px rgba(0,0,0,0.1);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{min-height:100%;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--background);color:var(--text-primary)}

        /* Header */
        .header{height:64px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:1000;box-shadow:var(--card-shadow)}
        .logo{font-size:24px;font-weight:800;color:var(--primary-color);letter-spacing:-.5px;text-decoration:none}
        .header-nav{display:flex;gap:16px;align-items:center}
        .btn{padding:8px 16px;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:.2s;text-decoration:none;display:inline-block;text-align:center;font-size:14px;background:#f1f5f9;color:var(--text-primary)}
        .btn:hover{background:#e2e8f0}
        .btn-primary{background:var(--primary-color);color:#fff}.btn-primary:hover{background:var(--primary-hover)}
        .btn-secondary{background:#f1f5f9;color:var(--text-primary)} .btn-secondary:hover{background:#e2e8f0}

        /* Layout */
        .container{display:flex;min-height:calc(100vh - 64px)}

        /* Sidebar */
        .sidebar{width:300px;background:#fff;padding:24px;border-right:1px solid var(--border)}
        .listings-count{font-size:48px;font-weight:bold;color:var(--primary-color);margin-bottom:4px}
        .listings-text{color:var(--text-secondary);font-size:14px;margin-bottom:16px}
        .view-all-btn{background:var(--primary-color);color:#fff;padding:12px 16px;border:none;border-radius:8px;font-weight:500;cursor:pointer;width:100%;margin-bottom:32px}

        /* Filters */
        .filter-title,.category-title{font-size:16px;font-weight:600;margin:24px 0 12px 0}
        .search-box{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:16px}
        .category-filter{display:flex;flex-direction:column;gap:8px}
        .category-item{display:flex;align-items:center;gap:8px}
        .category-item input{margin:0}
        .category-item label{cursor:pointer;font-size:14px}

        /* Main Content */
        .main-content{flex:1;padding:24px}
        .content-header{margin-bottom:32px}
        .page-title{font-size:32px;font-weight:700;margin-bottom:8px}
        .page-subtitle{color:var(--text-secondary);font-size:16px}

        /* Attractions Grid */
        .attractions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:24px;margin-bottom:32px}
        .attraction-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);transition:.2s;cursor:pointer}
        .attraction-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .card-image{width:100%;height:200px;background:#f8f9fa;position:relative}
        .card-image img{width:100%;height:100%;object-fit:cover}
        .card-content{padding:16px}
        .card-title{font-size:18px;font-weight:600;margin-bottom:8px;line-height:1.3}
        .card-meta{color:var(--text-secondary);font-size:14px;margin-bottom:8px}
        .card-categories{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0}
        .card-category{background:#eff6ff;color:#2563eb;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:500}
        .card-category.primary{background:#2563eb;color:#fff}
        .card-rating{color:#fbbf24;font-size:14px;margin-bottom:12px}

        /* 즐겨찾기 버튼 스타일 */
        .card-actions{display:flex;gap:8px;justify-content:space-between;align-items:center}
        .btn-detail {padding: 6px 12px;border: 1px solid #333;background: transparent;color: #333;border-radius: 4px;font-size: 13px;}        .btn-favorite{background:#ef4444;color:#fff;border:none;padding:8px 12px;border-radius:6px;font-size:12px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:4px}
        .btn-favorite:hover{background:#dc2626;transform:translateY(-1px)}
        .btn-favorite.favorited{background:#10b981}
        .btn-favorite.favorited:hover{background:#059669}

        /* Pagination */
        .pagination{display:flex;justify-content:center;gap:8px;margin-top:32px}
        .pagination button{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:6px;cursor:pointer}
        .pagination button.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
        .pagination button:hover:not(.active){background:#f8f9fa}

        .empty-state{text-align:center;padding:48px;color:var(--text-secondary);font-size:16px}
    </style>
</head>
<body>

<!-- Header -->
<header class="header">
    <a th:href="@{/}" class="logo">TATO</a>
    <nav class="header-nav">
        <a th:href="@{/}" class="btn">홈</a>
        <a th:href="@{/attractions}" class="btn btn-primary">목록</a>

        <span sec:authorize="isAnonymous()">
            <a th:href="@{/login}" class="btn btn-primary">로그인</a>
            <a th:href="@{/register}" class="btn">회원가입</a>
        </span>

        <span sec:authorize="isAuthenticated()">
            <a th:href="@{/favorites}" class="btn">즐겨찾기</a>
            <span th:text="${username}" sec:authentication="name">사용자</span>
            <form th:action="@{/logout}" method="post" style="display:inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-primary">로그아웃</button>
            </form>
        </span>
    </nav>
</header>

<div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="listings-count" id="listingsCount">0</div>
        <div class="listings-text">개의 관광지가 검색되었습니다.</div>
        <button class="view-all-btn" onclick="showAll()">전체 보기 →</button>

        <h3 class="filter-title">필터</h3>

        <!-- Search -->
        <input id="searchInput" class="search-box" placeholder="관광지 이름 검색..." onkeyup="applyFilters()">

        <!-- Categories -->
        <h4 class="category-title">카테고리</h4>
        <div id="categoryFilters" class="category-filter">
            <!-- 동적 생성 -->
        </div>

        <!-- 관광지 신청 버튼 추가 -->
        <div sec:authorize="isAuthenticated()" style="margin-top: 24px;">
            <a href="/favorites#submit" class="btn btn-secondary" style="width: 100%; text-align: center; display: block;">
                관광지 신청하기
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-header">
            <h1 class="page-title">도쿄 관광지</h1>
            <p class="page-subtitle">검색/필터로 원하는 장소를 빠르게 찾아보세요</p>
        </div>

        <section id="attractionsGrid" class="attractions-grid">
            <div class="empty-state">관광지를 불러오는 중...</div>
        </section>

        <div id="pagination" class="pagination" style="display:none;">
            <!-- 동적 생성 -->
        </div>
    </main>
</div>

<script>
    let allAttractions = [], filteredAttractions = [], currentPage = 1;
    const itemsPerPage = 9;
    let selectedCategories = new Set();

    // 수동 이미지 데이터
    const manualData = {
        images: {
            '1': '/images/attractions/architecture_img01.jpg',
            '2': '/images/attractions/architecture_img02.jpg',
            '3': '/images/attractions/architecture_img03.jpg',
            '4': '/images/attractions/architecture_img04.jpg',
            '5': '/images/attractions/architecture_img05.jpg',
            '6': '/images/attractions/architecture_img06.jpg',
            '7': '/images/attractions/architecture_img07.jpg',
            '8': '/images/attractions/architecture_img08.jpg',
            '9': '/images/attractions/architecture_img09.jpg'
        },
    };

    // 데이터 로딩
    fetch('/api/attractions')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('로드된 원본 데이터:', data);
            console.log('데이터 개수:', data.length);

            // 각 관광지의 카테고리 출력 (디버깅용)
            data.forEach((attraction, index) => {
                if (index < 5) { // 처음 5개만 출력
                    console.log(`관광지 ${index + 1}: ${attraction.name} - 카테고리: ${attraction.category}`);
                }
            });

            allAttractions = data;
            filteredAttractions = data;
            setupCategories();
            updateListingsCount();
            renderAttractions();
            renderPagination();

            console.log('데이터 로딩 완료. 검색 가능 상태.');
        })
        .catch(error => {
            console.error('데이터 로딩 실패:', error);
            document.getElementById('attractionsGrid').innerHTML =
                '<div class="empty-state">데이터를 불러오는데 실패했습니다.</div>';
        });

    function setupCategories() {
        // 🔧 카테고리 설정 수정 - 안전한 파싱
        const allCategories = new Set();

        allAttractions.forEach(attraction => {
            if (attraction.category) {
                // 쉼표 구분
                const categories = attraction.category.split(',').map(c => c.trim()).filter(c => c);
                categories.forEach(category => allCategories.add(category));
            }
        });

        const categoriesArray = Array.from(allCategories).sort();
        const container = document.getElementById('categoryFilters');

        container.innerHTML = categoriesArray.map(category => `
            <div class="category-item">
                <input type="checkbox" id="category_${category}" onchange="toggleCategory('${category}')">
                <label for="category_${category}">${escapeHtml(category)}</label>
            </div>
        `).join('');
    }

    function toggleCategory(category) {
        if (selectedCategories.has(category)) {
            selectedCategories.delete(category);
        } else {
            selectedCategories.add(category);
        }
        applyFilters();
    }

    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredAttractions = allAttractions.filter(attraction => {
            const matchesSearch = !searchTerm ||
                attraction.name.toLowerCase().includes(searchTerm) ||
                (attraction.category && attraction.category.toLowerCase().includes(searchTerm)) ||
                attraction.address.toLowerCase().includes(searchTerm);

            const matchesCategory = selectedCategories.size === 0 ||
                (attraction.category &&
                    attraction.category.split(',').map(c => c.trim()).some(cat => selectedCategories.has(cat)));

            return matchesSearch && matchesCategory;
        });

        currentPage = 1;
        updateListingsCount();
        renderAttractions();
        renderPagination();
    }

    function updateListingsCount() {
        document.getElementById('listingsCount').textContent = filteredAttractions.length;
    }

    function renderAttractions() {
        const container = document.getElementById('attractionsGrid');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageAttractions = filteredAttractions.slice(startIndex, endIndex);

        if (pageAttractions.length === 0) {
            container.innerHTML = '<div class="empty-state">검색 결과가 없습니다</div>';
            return;
        }

        container.innerHTML = pageAttractions.map(attraction => {
            const rating = 5.0;
            const imageUrl = manualData.images[attraction.id];
            const stars = '★★★★★';

            // 카테고리를 쉼표로 분할하여 개별 태그 생성
            let categoryTags = '';
            if (attraction.category) {
                try {
                    const categories = attraction.category.split(',').map(c => c.trim()).filter(c => c);
                    categoryTags = categories.map((category, index) =>
                        `<span class="card-category${index === 0 ? ' primary' : ''}">${escapeHtml(category)}</span>`
                    ).join('');
                } catch (error) {
                    console.error('카테고리 파싱 오류:', error);
                    categoryTags = '<span class="card-category">기타</span>';
                }
            } else {
                categoryTags = '<span class="card-category">기타</span>';
            }

            return `
            <div class="attraction-card">
                <div class="card-image" onclick="goToDetail('${attraction.id}')">
                    ${imageUrl ?
                `<img src="${imageUrl}" alt="${escapeHtml(attraction.name)}" />` :
                '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">📍</div>'
            }
                </div>
                <div class="card-content">
                    <div class="card-title" onclick="goToDetail('${attraction.id}')">${escapeHtml(attraction.name)}</div>
                    <div class="card-meta">${escapeHtml(attraction.address || '')}</div>
                    <div class="card-categories">${categoryTags}</div>
                    <div class="card-rating">${stars} ${rating}</div>

                    <!--  버튼 영역 추가 -->
                    <div class="card-actions">
                        <button class="btn-favorite" onclick="toggleFavorite(${attraction.id}, this)" data-attraction-id="${attraction.id}">
                            즐겨찾기
                        </button>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    function renderPagination() {
        const container = document.getElementById('pagination');
        const totalPages = Math.ceil(filteredAttractions.length / itemsPerPage);

        if (totalPages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';
        let paginationHTML = '';

        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `
                <button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                    ${i}
                </button>
            `;
        }

        container.innerHTML = paginationHTML;
    }

    function goToPage(page) {
        currentPage = page;
        renderAttractions();
        renderPagination();
        window.scrollTo(0, 0);
    }

    function goToDetail(id) {
        window.location.href = `/attractions/${id}`;
    }

    function showAll() {
        selectedCategories.clear();
        document.getElementById('searchInput').value = '';
        document.querySelectorAll('#categoryFilters input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        applyFilters();
    }

    //  CSRF 토큰 가져오기
    function getCsrfToken() {
        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
        return {
            token: csrfToken ? csrfToken.getAttribute('content') : null,
            header: csrfHeader ? csrfHeader.getAttribute('content') : null
        };
    }

    //  즐겨찾기 토글 함수
    async function toggleFavorite(attractionId, button) {
        console.log('즐겨찾기 토글 시도:', attractionId);

        // 강화된 로그인 체크 - 여러 방법으로 확인
        const authSpan = document.querySelector('span[sec\\:authorize="isAuthenticated()"]');
        const userSpan = document.querySelector('span[sec\\:authentication="name"]');
        const csrfToken = document.querySelector('meta[name="_csrf"]');
        const logoutForm = document.querySelector('form[action*="/logout"]');

        const isLoggedIn = authSpan || userSpan || (csrfToken && logoutForm);

        console.log('로그인 상태 체크:', {
            authSpan: !!authSpan,
            userSpan: !!userSpan,
            csrfToken: !!csrfToken,
            logoutForm: !!logoutForm,
            isLoggedIn: !!isLoggedIn
        });

        if (!isLoggedIn) {
            alert('로그인이 필요합니다.');
            window.location.href = '/login';
            return;
        }

        try {
            const csrf = getCsrfToken();
            const headers = {
                'Content-Type': 'application/json',
            };

            if (csrf.token && csrf.header) {
                headers[csrf.header] = csrf.token;
            }

            // 버튼 비활성화
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = '처리중...';

            const response = await fetch(`/favorites/${attractionId}`, {
                method: 'POST',
                headers: headers
            });

            console.log('즐겨찾기 응답 상태:', response.status);

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    alert('로그인이 필요합니다.');
                    window.location.href = '/login';
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log('즐겨찾기 응답:', result);

            if (result.success) {
                // 버튼 상태 업데이트
                if (result.favorited) {
                    button.classList.add('favorited');
                    button.textContent = '즐겨찾기 추가';
                } else {
                    button.classList.remove('favorited');
                    button.textContent = '즐겨찾기 제거';
                }

                // 성공 메시지
                showToast(result.message);
            } else {
                throw new Error(result.message || '오류가 발생했습니다.');
            }

        } catch (error) {
            console.error('즐겨찾기 처리 중 오류:', error);
            alert('네트워크 오류가 발생했습니다: ' + error.message);

            // 에러시 버튼 복구
            button.textContent = originalText;
        } finally {
            button.disabled = false;
        }
    }

    //  토스트 메시지 표시
    function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

</body>
</html>