<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="utf-8" />
  <title>TATO - ë„ì¿„ ê´€ê´‘ì§€ í•œëˆˆì—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <link th:href="@{/css/base.css}" rel="stylesheet">

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --primary:#2563eb; --primary-hover:#1d4ed8;
      --bg:#f8fafc; --text:#1e293b; --muted:#64748b; --border:#e2e8f0;
      --shadow:0 1px 3px 0 rgb(0 0 0 / .1);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}

    /* Header */
    .header{height:64px;background:#fff;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:1000;box-shadow:var(--shadow)}
    .logo{font-size:24px;font-weight:800;color:var(--primary-color);text-decoration:none}
    .header-nav{display:flex;gap:10px;align-items:center}
    .btn{padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:#fff;color:var(--text);text-decoration:none;font-size:14px}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn:hover{filter:brightness(0.98)}
    .user{font-size:14px;color:var(--muted)}

    /* Layout */
    .main{display:grid;grid-template-columns:380px 1fr;height:calc(100vh - 64px)}
    @media (max-width:900px){.main{grid-template-columns:1fr;grid-template-rows:320px 1fr}}

    /* Sidebar */
    .side{background:#fff;border-right:1px solid var(--border);overflow:auto}
    .side-sec{padding:20px 24px;border-bottom:1px solid var(--border)}
    .title{font-size:18px;font-weight:700;margin-bottom:6px}
    .subtitle{color:var(--muted);font-size:13px}
    .search{display:flex;gap:8px;margin-top:12px}
    .input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:8px}
    .input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgb(37 99 235 / .12)}
    .pill-wrap{display:flex;flex-wrap:wrap;gap:8px}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff;cursor:pointer}
    .pill.active{background:var(--primary);border-color:var(--primary);color:#fff}

    .list{padding:18px 24px}
    .hint{font-size:12px;color:var(--muted);margin-bottom:10px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:10px;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
    .card:hover{transform:translateY(-1px);border-color:var(--primary)}
    .name{font-weight:700;margin-bottom:4px}
    .meta{font-size:12px;color:var(--muted)}
    .badge{display:inline-block;margin-top:6px;background:#eff6ff;color:var(--primary);border-radius:999px;padding:2px 8px;font-size:11px}

    /* ì¹´í…Œê³ ë¦¬ íƒœê·¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .categories-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .category-tag {
      background: #eff6ff;
      color: #2563eb;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      border: 1px solid #e0f2fe;
      font-weight: 500;
      display: inline-block;
    }

    .category-tag.primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
      font-weight: 600;
    }

    /* Map */
    .map-wrap{position:relative}
    #map{width:100%;height:100%}
    .map-tools{position:absolute;top:14px;right:14px;display:flex;flex-direction:column;gap:8px;z-index:1000}
    .tool{background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px}
  </style>
</head>
<body>
<header class="header">
  <a th:href="@{/}" class="logo">TATO</a>
  <nav class="header-nav">
    <a th:href="@{/}" class="btn">í™ˆ</a>
    <a th:href="@{/attractions}" class="btn">ëª©ë¡</a>

    <!-- ë¡œê·¸ì¸ ì „ ì‚¬ì´íŠ¸ ëª¨ìŠµ -->
    <span sec:authorize="isAnonymous()">
      <a th:href="@{/login}" class="btn primary">ë¡œê·¸ì¸</a>
      <a th:href="@{/register}" class="btn">íšŒì›ê°€ì…</a>
    </span>

    <!-- ë¡œê·¸ì¸ í›„ ì‚¬ì´íŠ¸ -->
    <span sec:authorize="isAuthenticated()">
      <a th:href="@{/favorites}" class="btn">ì¦ê²¨ì°¾ê¸°</a>
      <span sec:authorize="hasRole('ROLE_ADMIN')">
        <a th:href="@{/admin}" class="btn">ê´€ë¦¬ì</a>
      </span>
      <span class="user" th:text="${username}">ì‚¬ìš©ì</span>
      <form th:action="@{/logout}" method="post" style="display:inline;">
        <button type="submit" class="btn primary">ë¡œê·¸ì•„ì›ƒ</button>
      </form>
    </span>
  </nav>
</header>

<main class="main">
  <!-- Sidebar -->
  <aside class="side">
    <section class="side-sec">
      <div class="title">ë„ì¿„ ê´€ê´‘ì§€ íƒìƒ‰</div>
      <div class="subtitle">ì§€ë„ì—ì„œ ì„ íƒí•˜ê±°ë‚˜, ì•„ë˜ ê²€ìƒ‰/í•„í„°ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.</div>
      <div class="search">
        <input id="q" class="input" type="text" placeholder="ê´€ê´‘ì§€/ì£¼ì†Œ/ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰" onkeydown="if(event.key==='Enter') applyFilters()">
        <button class="btn primary" onclick="applyFilters()">ê²€ìƒ‰</button>
      </div>
    </section>

    <section class="side-sec">
      <div class="title" style="font-size:14px">ì¹´í…Œê³ ë¦¬</div>
      <div id="catPills" class="pill-wrap"><!-- ë™ì  --></div>
    </section>

    <section class="list">
      <div class="hint">ëª©ë¡ì„ í´ë¦­í•˜ë©´ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤</div>
      <div id="listBox"><div class="meta">ê´€ê´‘ì§€ ë¡œë”© ì¤‘â€¦</div></div>
    </section>
  </aside>

  <!-- Map -->
  <section class="map-wrap">
    <div id="map"></div>
    <div class="map-tools">
      <button class="tool" title="ì „ì²´ë³´ê¸°" onclick="resetView()">ğŸŒ</button>
    </div>
  </section>
</main>

<script>
  // ì „ì—­ ìƒíƒœ
  let map, cluster, all = [], filtered = [], activeCat = null;

  // ì´ˆê¸°í™”
  initMap();

  // DOM ë¡œë“œ ì™„ë£Œ í›„ APIì—ì„œ ë°ì´í„° ë¡œë“œ
  document.addEventListener('DOMContentLoaded', function() {
    loadAttractionsFromApi();
  });

  function initMap(){
    map = L.map('map').setView([35.681236,139.767125], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    cluster = L.markerClusterGroup({maxClusterRadius:50, chunkedLoading:true});
    map.addLayer(cluster);
  }
  function resetView(){ map.setView([35.681236,139.767125], 11); }

  function loadAttractionsFromApi(){
    console.log('APIì—ì„œ ê´€ê´‘ì§€ ë°ì´í„° ë¡œë”© ì‹œì‘...');

    fetch('/api/attractions')
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              console.log('APIì—ì„œ ë¡œë“œëœ ë°ì´í„°:', data.length, 'ê°œ í•­ëª©');

              if (!data || data.length === 0) {
                showErrorMessage('ê´€ê´‘ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              // ë°ì´í„° ë³€í™˜ ë° ì¹´í…Œê³ ë¦¬ ë¶„í•  ì²˜ë¦¬
              all = data.map(a => ({
                id: a.id,
                name: a.name || '',
                category: a.category || 'ê¸°íƒ€',
                categories: (a.category || 'ê¸°íƒ€').split(',').map(c => c.trim()).filter(c => c),
                address: a.address || '',
                lat: a.latitude,
                lng: a.longitude,
                description: a.description || ''
              })).filter(a => !Number.isNaN(a.lat) && !Number.isNaN(a.lng));

              console.log('ì²˜ë¦¬ëœ ê´€ê´‘ì§€ ë°ì´í„°:', all.length, 'ê°œ');

              if (all.length === 0) {
                showErrorMessage('ìœ íš¨í•œ ê´€ê´‘ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              initCategoryPills();
              filtered = [...all];
              renderMarkers();
              renderList();
            })
            .catch(error => {
              console.error('ê´€ê´‘ì§€ ë°ì´í„° ë¡œë”© ì—ëŸ¬:', error);
              showErrorMessage('ê´€ê´‘ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
            });
  }

  function showErrorMessage(message) {
    document.getElementById('listBox').innerHTML =
            '<div style="color:#ef4444; text-align:center; padding:20px;">' + escapeHtml(message) + '</div>';
  }

  // ì¹´í…Œê³ ë¦¬ í•„í„° (ê°œì„ ëœ ë²„ì „)
  function initCategoryPills(){
    // ëª¨ë“  ê°œë³„ ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘
    const allCats = new Set();
    all.forEach(a => {
      if (a.categories && a.categories.length > 0) {
        a.categories.forEach(cat => {
          if (cat && cat.trim()) {
            allCats.add(cat.trim());
          }
        });
      }
    });

    const cats = Array.from(allCats).filter(Boolean).sort();
    const box = document.getElementById('catPills');

    if (cats.length === 0) {
      box.innerHTML = '<div class="meta">ì¹´í…Œê³ ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      return;
    }

    box.innerHTML = cats.map(c =>
            `<button class="pill" data-cat="${escapeHtml(c)}" onclick="toggleCat('${escapeHtml(c)}', event)">${escapeHtml(c)}</button>`
    ).join('');
  }

  function toggleCat(cat, ev){
    const pills = document.querySelectorAll('.pill');
    pills.forEach(p=>p.classList.remove('active'));
    if(activeCat === cat){
      activeCat = null;
    } else {
      activeCat = cat;
      ev.currentTarget.classList.add('active');
    }
    applyFilters();
  }

  // í•„í„°/ê²€ìƒ‰ ì ìš© (ê°œì„ ëœ ì¹´í…Œê³ ë¦¬ ë§¤ì¹­)
  function applyFilters(){
    const term = document.getElementById('q').value.trim().toLowerCase();
    filtered = all.filter(a=>{
      // ì¹´í…Œê³ ë¦¬ ë§¤ì¹­ ê°œì„  (ê°œë³„ ì¹´í…Œê³ ë¦¬ì™€ ë§¤ì¹­)
      const okCat = !activeCat || (a.categories && a.categories.includes(activeCat));
      const okTerm = !term || [a.name, a.address, ...a.categories].some(v => (v||'').toLowerCase().includes(term));
      return okCat && okTerm;
    });
    renderMarkers();
    renderList();

    // ê²€ìƒ‰ ì‹œ ì²« ê²°ê³¼ë¡œ ì´ë™
    if(term && filtered.length){
      const f = filtered[0];
      map.setView([f.lat, f.lng], 14);
    }
  }

  // ë§ˆì»¤/íŒì—…
  function renderMarkers(){
    cluster.clearLayers();
    filtered.forEach(a=>{
      const m = L.marker([a.lat, a.lng]);
      const html = `
      <div style="min-width:220px">
        <div style="font-weight:700;margin-bottom:6px">${escapeHtml(a.name)}</div>
        ${a.category?`<div class="meta"><b>ì¹´í…Œê³ ë¦¬</b> ${escapeHtml(a.category)}</div>`:''}
        ${a.address?`<div class="meta"><b>ì£¼ì†Œ</b> ${escapeHtml(a.address)}</div>`:''}
        ${a.description?`<div class="meta" style="margin-top:6px">${escapeHtml(a.description)}</div>`:''}
        <div style="margin-top:10px;display:flex;gap:8px">
          <a class="btn primary" href="/attractions/${encodeURIComponent(a.id)}">ìƒì„¸ë³´ê¸°</a>
          <button class="btn" onclick="fav('${a.id}')">ì¦ê²¨ì°¾ê¸°</button>
        </div>
      </div>`;
      m.bindPopup(html);
      cluster.addLayer(m);
    });
  }

  // ëª©ë¡ ë Œë”ë§ (ê°œì„ ëœ ì¹´í…Œê³ ë¦¬ íƒœê·¸ í‘œì‹œ)
  function renderList(){
    const box = document.getElementById('listBox');
    if(!filtered.length){
      box.innerHTML = '<div class="meta" style="text-align:center; padding:20px;">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }

    box.innerHTML = filtered.map(a => {
      // ì¹´í…Œê³ ë¦¬ë¥¼ ê°œë³„ íƒœê·¸ë¡œ í‘œì‹œ
      let categoryTags = '';
      if (a.categories && a.categories.length > 0) {
        categoryTags = a.categories.map((category, index) =>
                `<span class="category-tag${index === 0 ? ' primary' : ''}">${escapeHtml(category)}</span>`
        ).join(' ');
      } else {
        categoryTags = '<span class="category-tag">ê¸°íƒ€</span>';
      }

      return `
        <article class="card" onclick="goto('${a.id}')">
          <div class="name">${escapeHtml(a.name)}</div>
          <div class="meta">${escapeHtml(a.address || '')}</div>
          <div class="categories-container">
            ${categoryTags}
          </div>
        </article>
      `;
    }).join('');
  }

  function getCsrfToken() {
    const csrfToken = document.querySelector('meta[name="_csrf"]');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
    return {
      token: csrfToken ? csrfToken.getAttribute('content') : null,
      header: csrfHeader ? csrfHeader.getAttribute('content') : null
    };
  }

  // ì¦ê²¨ì°¾ê¸° ì•¡ì…˜
  async function fav(id){
    console.log('ì¦ê²¨ì°¾ê¸° ìš”ì²­:', id);

    //  ë¡œê·¸ì¸ ì²´í¬ ê°œì„  - Thymeleaf ë Œë”ë§ëœ ìš”ì†Œ í™•ì¸
    const isLoggedIn = document.querySelector('span[sec\\:authorize="isAuthenticated()"]') ||
            document.querySelector('span.user') ||
            document.querySelector('input[name="_csrf"]'); // CSRF í† í° ì¡´ì¬ í™•ì¸

    if (!isLoggedIn) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      window.location.href = '/login';
      return;
    }

    try {
      const csrf = getCsrfToken();
      const headers = {
        'Content-Type': 'application/json',
      };

      if (csrf.token && csrf.header) {
        headers[csrf.header] = csrf.token;
      }

      const response = await fetch(`/favorites/${encodeURIComponent(id)}`, {
        method: 'POST',
        headers: headers
      });

      if (!response.ok) {
        if (response.status === 401 || response.status === 403) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      console.log('ì¦ê²¨ì°¾ê¸° ì‘ë‹µ:', result); // ë””ë²„ê¹…ìš©

      if (result.success) {
        // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ ìƒíƒœ í‘œì‹œ
        const message = result.favorited ?
                'ì¦ê²¨ì°¾ê¸° ì™„ë£Œ' :
                'ì¦ê²¨ì°¾ê¸° ì œê±°';

        alert(message);

        // ì„ íƒì : ë²„íŠ¼ í…ìŠ¤íŠ¸ë‚˜ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        updateFavoriteButtons(id, result.favorited);

      } else {
        alert(result.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
      alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  }

  function updateFavoriteButtons(attractionId, isFavorited) {
    // ì§€ë„ íŒì—…ì˜ ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ ì°¾ê¸°
    const popupButtons = document.querySelectorAll(`button[onclick="fav('${attractionId}')"]`);

    popupButtons.forEach(button => {
      if (isFavorited) {
        button.style.background = '#ef4444';
        button.textContent = 'ì¦ê²¨ì°¾ê¸° ì œê±°';
      } else {
        button.style.background = '#10b981';
        button.textContent = 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€';
      }
    });

    const listButtons = document.querySelectorAll(`button[data-attraction-id="${attractionId}"]`);
    listButtons.forEach(button => {
      if (isFavorited) {
        button.classList.add('favorited');
        button.textContent = 'ì¦ê²¨ì°¾ê¸° ë˜ì–´ìˆìŠµë‹ˆë‹¤.';
      } else {
        button.classList.remove('favorited');
        button.textContent = 'ì¦ê²¨ì°¾ê¸°';
      }
    });
  }

  function goto(id){
    console.log('ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™:', id);
    window.location.href = `/attractions/${encodeURIComponent(id)}`;
  }

  // util
  function escapeHtml(s=''){
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }
</script>
</body>
</html>